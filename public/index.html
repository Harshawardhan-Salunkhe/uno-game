<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UNO BATTLE</title>
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="casino.css">
    <link rel="icon" type="image/png" sizes="192x192" href="icon.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* --- DEFAULT LAYOUT (PORTRAIT) --- */
        #menu-screen, #lobby-waiting {
            display: flex; flex-direction: column !important; align-items: center; justify-content: center; gap: 20px;
            width: 90%; max-width: 400px; padding: 30px; margin: auto; text-align: center;
        }
        #lobby-code-input {
            text-transform: uppercase; padding: 12px; width: 140px; text-align: center; 
            font-size: 22px; color: black; font-weight: bold; border-radius: 8px; border: none; outline: none;
        }

        /* --- PLAYER SIDEBAR (DEFAULT) --- */
        #game-sidebar {
            position: absolute;
            left: 0;
            top: 70px; 
            max-height: 50vh; 
            width: 120px;
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 0 10px 10px 0; 
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 50;
            pointer-events: none; 
            margin-top: 30px;
        }
        
        .sidebar-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px;
            border-radius: 4px;
            font-size: 12px;
            color: white;
            text-align: left;
            pointer-events: auto; 
        }
        .sidebar-item.active-turn {
            background: rgba(255, 215, 0, 0.3);
            border-left: 3px solid gold;
        }
        .sidebar-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #leaderboard-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); 
            display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 2000;
        }
        .rank-item {
            background: rgba(255,255,255,0.1); padding: 15px; width: 300px; margin: 5px;
            border-radius: 10px; display: flex; justify-content: space-between; font-size: 20px;
        }
        .gold { border: 2px solid gold; color: gold; }

        /* ============================================================
           MOBILE LANDSCAPE MODE (Activates when phone is sideways)
           ============================================================ */
        @media (max-height: 600px) and (orientation: landscape) {

            /* 1. CENTER TABLE (Dead Center & Scaled Down) */
            .center-table {
                position: absolute !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) scale(0.6) !important;
                width: auto !important;
                height: auto !important;
                z-index: 10 !important;
            }

            /* 2. HAND CONTAINER (Pinned Fixed to Bottom) */
           /* 2. HAND CONTAINER (Scrollable & Bottom Pinned) */
            .hand-container {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: 85px !important; /* Touch-friendly height */
                
                /* FLEX SETTINGS */
                display: flex !important;
                align-items: flex-end !important;
                
                /* CRITICAL: Start from left to allow scrolling. 
                   We use auto-margins on cards to center them instead. */
                justify-content: center  !important; 
                
                /* ENABLE SCROLLING */
                overflow-x: auto !important;
                overflow-y: hidden !important;
                
                padding: 0 !important;
                margin: 0 !important;
                z-index: 100 !important;
                background: rgba(0,0,0,0.2) !important;
            }

            /* 3. CARDS IN HAND ONLY (Small & Overlapping) */

            #my-hand{
    transform: translateX(0%) !important;
}
            .hand-container .card {
                width: 60px !important;
                height: 65px !important;
                background-size: contain !important;
                margin: 0 -12px 5px -12px !important; /* Tight overlap */
                flex-shrink: 0 !important; /* Prevent squishing */
                position: relative !important;
            }

            /* --- THE CENTERING MAGIC --- */
            /* This pushes the cards to the middle if there are few, 
               but lets them scroll normally if there are many. */
            .hand-container .card:first-child {
                margin-left: auto !important;
            }

            .hand-container .card:last-child {
                margin-right: auto !important;
            }
            

            /* 4. SIDEBAR (Moved & Scaled) */
            #game-sidebar {
                position: fixed !important;
                top: 55px !important;
                left: 10px !important;
                bottom: auto !important;
                width: 110px !important;
                max-height: 180px !important;
                transform: scale(0.85) !important;
                transform-origin: top left;
                z-index: 50 !important;
                margin-top: 30px;
            }

            /* 5. LOBBY SCREEN (Side-by-Side) */
            #lobby-waiting {
                
                width: 90% !important;
                padding: 10px !important;
            }
        }
    </style>
</head>
<body>

    <div id="menu-screen" class="glass-panel" style="display: flex;">
        <h1 style="font-size: 32px; margin: 0;">UNO BATTLE</h1>
        <h3 id="welcome-msg" style="margin-top: 5px; opacity: 0.8;">Welcome...</h3>
        
        <div style="width: 100%; height: 1px; background: rgba(255,255,255,0.3); margin: 10px 0;"></div>
        <button class="btn-success" onclick="createLobby()" style="width: 100%; font-size: 18px;">CREATE LOBBY</button>
        <p style="margin: 5px 0; opacity: 0.6;">- OR -</p>
        <div style="display: flex; gap: 10px; justify-content: center; width: 100%;">
            <input type="text" id="lobby-code-input" placeholder="CODE" maxlength="6">
            <button class="btn-warn" onclick="joinLobby()">JOIN</button>
        </div>
        <button class="btn-warn" onclick="logout()" style="margin-top:20px; background: #444; width: auto; font-size: 14px;">Log Out</button>
    </div>

    <div id="lobby-waiting" class="glass-panel" style="display: none;">
        <div style="opacity: 0.8; font-size: 14px;">ROOM CODE</div>
        <h1 id="lobby-code-display" style="font-size: 60px; color: gold; margin: 0; letter-spacing: 5px;">...</h1>
        <p style="font-size: 14px; opacity: 0.7;">Share this code with friends!</p>
        <div id="p-list" style="width: 100%; min-height: 50px;"></div>
        <button id="start-btn" class="btn-success" onclick="startGame()" style="width: 100%; font-size: 20px; padding: 15px;">START GAME</button>
    </div>

    <div id="game-area" style="display:none;">
        <div id="game-sidebar"></div> 

        <div class="top-bar">
            <div class="glass-panel" style="padding: 5px 15px; width:auto; min-width: 120px; text-align: center;">
                <h3 id="turn-text" style="margin:0; font-size: 14px;">Waiting...</h3>
                <div id="direction-text" style="color: #aaa; font-size: 10px;">CLOCKWISE</div>
                <div id="countdown" style="color:orange; font-weight:bold; height:20px; font-size:12px;"></div>
            </div>
            <button id="uno-btn" class="btn-warn" style="width:auto; height: 50px; font-size:16px; padding: 0 15px;" onclick="sayUno()">UNO!</button>
        </div>

        <div class="center-table">
            <div class="card" onclick="drawCard()" style="background-image: url('cards/card_back.png'); background-size: contain; background-repeat: no-repeat; background-position: center; border: 2px dashed rgba(255,255,255,0.3);"></div>
            <div id="top-card" class="card"></div>
            <div id="active-color-dot" style="width:30px; height:30px; border-radius:50%; background:gray; border:3px solid white; box-shadow: 0 0 10px black;"></div>
        </div>

        <div class="hand-container" id="my-hand"></div>
    </div>

    <div id="color-modal">
        <div class="glass-panel" style="flex-direction: column;">
            <h2>Pick Color</h2>
            <div style="display: flex; gap: 10px;">
                <div class="color-option" style="background:red;" onclick="resolveWild('Red')"></div>
                <div class="color-option" style="background:blue;" onclick="resolveWild('Blue')"></div>
                <div class="color-option" style="background:green;" onclick="resolveWild('Green')"></div>
                <div class="color-option" style="background:orange;" onclick="resolveWild('Yellow')"></div>
            </div>
        </div>
    </div>

    <div id="leaderboard-modal">
        <h1 style="font-size: 40px; margin-bottom: 20px;">GAME OVER</h1>
        <div id="ranking-list"></div>
        <div style="margin-top: 30px;">
            <button class="btn-warn" onclick="quitGame()">BACK TO MENU</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="animations.js"></script>
    <script>
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(console.log);

        const username = localStorage.getItem('unoUser');
        if (!username) window.location.href = 'login.html';
        document.getElementById('welcome-msg').innerText = "Player: " + username;

        const socket = io();
        let pendingCardIndex = null;
        let myLobbyCode = null; 
        let countdownInterval = null;

        function createLobby() { socket.emit('createLobby', username); }
        function joinLobby() {
            const code = document.getElementById('lobby-code-input').value.trim().toUpperCase();
            if (code.length !== 6) return alert("Invalid Code");
            socket.emit('joinLobby', { code, username });
        }
        function logout() { localStorage.removeItem('unoUser'); window.location.href = 'login.html'; }
        function startGame() { if(myLobbyCode) socket.emit('startGame', myLobbyCode); }
        function drawCard() { socket.emit('drawCard', myLobbyCode); }
        function sayUno() { socket.emit('sayUno', myLobbyCode); }
        function quitGame() { window.location.reload(); }
        
        function attemptPlay(index, card) {
            if (card.color === 'Black') {
                pendingCardIndex = index;
                document.getElementById('color-modal').style.display = 'flex';
            } else {
                socket.emit('playCard', { code: myLobbyCode, cardIndex: index, chosenColor: null });
            }
        }
        function resolveWild(color) {
            socket.emit('playCard', { code: myLobbyCode, cardIndex: pendingCardIndex, chosenColor: color });
            document.getElementById('color-modal').style.display = 'none';
        }

        // --- SOCKET EVENTS ---
        socket.on('lobbyCreated', (code) => {
            myLobbyCode = code;
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('lobby-waiting').style.display = 'flex';
            document.getElementById('lobby-code-display').innerText = code;
        });
        socket.on('joinedLobby', (code) => {
            myLobbyCode = code;
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('lobby-waiting').style.display = 'flex';
            document.getElementById('lobby-code-display').innerText = code;
        });
        socket.on('error', (msg) => alert(msg));
        
        socket.on('updatePlayerList', (players) => {
            document.getElementById('p-list').innerHTML = players.map(p => `
                <div style="background: rgba(0,0,0,0.3); padding:10px; margin-bottom: 5px; border-radius: 6px; display:flex; justify-content:space-between; align-items: center; font-size: 16px;">
                    <span style="font-weight: bold;">üë§ ${p.name}</span>
                    ${p.finished ? '<span style="color:gold;">üèÜ Won</span>' : '<span style="color:#aaa; font-size:12px;">Ready</span>'}
                </div>`).join('');
        });
        
        socket.on('message', (msg) => { if(msg.includes('STRICT') || msg.includes('shouted')) alert(msg); });

        // --- TIMER ANIMATION ---
        socket.on('timerStart', (seconds) => {
            const el = document.getElementById('countdown');
            let left = seconds;
            el.innerText = `ACT FAST: ${left}s`;
            if(countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                left--;
                if(left <= 0) { el.innerText = ""; clearInterval(countdownInterval); }
                else { el.innerText = `ACT FAST: ${left}s`; }
            }, 1000);
        });

        socket.on('gameState', (state) => {
            const topCard = state.topCard;
            
            // --- ANIMATION LOGIC ---
            if (window.lastAnimatedCard !== topCard.color + topCard.value) {
                window.lastAnimatedCard = topCard.color + topCard.value; 

                if (topCard.value.includes('Draw4')) playAnimation('DRAW_4');
                else if (topCard.value === 'Draw2') playAnimation('DRAW_2');
                else if (topCard.value === 'Reverse') playAnimation('REVERSE');
                else if (topCard.value === 'Skip') playAnimation('SKIP');
                else if (topCard.color === 'Black' && !topCard.value.includes('Draw4')) playAnimation('WILD');
            }
                
            if(countdownInterval) { clearInterval(countdownInterval); document.getElementById('countdown').innerText = ""; }

            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('lobby-waiting').style.display = 'none';
            document.getElementById('game-area').style.display = 'flex';

            const isMe = state.currentPlayer === socket.id;
            const currentPlayerObj = state.playerInfo.find(p => p.id === state.currentPlayer);
            const currentName = currentPlayerObj ? currentPlayerObj.name : "Unknown";
            
            document.getElementById('turn-text').innerText = isMe ? "YOUR TURN" : `${currentName.toUpperCase()}'S TURN`;
            document.getElementById('turn-text').style.color = isMe ? "#38ef7d" : "white";
            document.getElementById('direction-text').innerText = state.direction;

            // --- SIDEBAR UPDATE ---
            const sidebar = document.getElementById('game-sidebar');
            sidebar.innerHTML = "";
            state.playerInfo.forEach(p => {
                const isActive = (p.id === state.currentPlayer);
                sidebar.innerHTML += `
                    <div class="sidebar-item ${isActive ? 'active-turn' : ''}">
                        <div class="sidebar-name">${p.name} ${p.id === socket.id ? '(You)' : ''}</div>
                        <div style="opacity:0.7;">üÉè ${p.cards} Cards</div>
                    </div>
                `;
            });

            const unoBtn = document.getElementById('uno-btn');
            unoBtn.style.opacity = isMe ? "1" : "0.5";

            const topDiv = document.getElementById('top-card');
            let fileName = `${state.topCard.color}_${state.topCard.value.replace(' ', '')}.png`;
            topDiv.style.backgroundImage = `url('cards/${fileName}')`;
            topDiv.innerText = ""; topDiv.className = "card"; 

            const dotColor = state.currentColor === 'Black' ? 'gray' : 
                             (state.currentColor === 'Blue' ? '#5555ff' : 
                             (state.currentColor === 'Red' ? '#ff5555' : 
                             (state.currentColor === 'Green' ? '#55aa55' : '#ffaa00')));
            document.getElementById('active-color-dot').style.background = dotColor;
        });

        socket.on('yourHand', (hand) => {
            const div = document.getElementById('my-hand');
            div.innerHTML = "";
            hand.forEach((card, index) => {
                const el = document.createElement('div');
                el.className = 'card';
                let fileName = `${card.color}_${card.value.replace(' ', '')}.png`;
                el.style.backgroundImage = `url('cards/${fileName}')`;
                el.onclick = () => attemptPlay(index, card);
                div.appendChild(el);
            });
        });

        socket.on('gameOver', (winners) => {
            const modal = document.getElementById('leaderboard-modal');
            const list = document.getElementById('ranking-list');
            list.innerHTML = "";
            winners.forEach((p, i) => {
                let rankClass = i===0 ? "gold" : "";
                list.innerHTML += `
                    <div class="rank-item ${rankClass}">
                        <span>#${i+1} ${p.name}</span>
                        <span>${i===0 ? 'üëë' : ''}</span>
                    </div>
                `;
            });
            modal.style.display = 'flex';
        });
    </script>
</body>
</html>










